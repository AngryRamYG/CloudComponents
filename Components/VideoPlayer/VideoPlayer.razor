@namespace AngryMonkey.Cloud.Components
@inject IJSRuntime jsRuntime

<div class="amc-videoplayer @ClassAttributes" @ref="ComponentElement" @onmousemove="MainMouseMove" @onfullscreenchange="OnFullScreenChange">

    <div class="amc-videoplayer-video">
        <video src="@VideoUrl" @onload="VideoLoaded" @onchange="OnVideoChange"></video>
    </div>

    <div class="amc-videoplayer-empty" @onclick="OnEmptyClick">
        
    </div>

    <div class="amc-videoplayer-info">
        <div class="amc-videoplayer-title">@Title</div>
    </div>

    <div class="amc-videoplayer-controls">
        <div class="amc-videoplayer-controls-left">
            <button class="amc-videoplayer-play" @onclick="PlayVideo">
                <svg viewBox="0 0 36 40">
                    <path class="amc-videoplayer-svg-fill" d="M34.5,19.1C34.5,19.1,34.5,19.1,34.5,19.1c0-0.5-0.2-0.8-0.6-1L6.5,3.2l0,0C6.3,3.1,6.1,3.1,5.9,3.1h0
	                c0,0,0,0,0,0c-0.6,0-1.1,0.5-1.1,1.1v29.7l0,0v0c0,0.6,0.5,1.1,1.1,1.1c0.2,0,0.4-0.1,0.5-0.1l27.4-14.9l0,0
	                C34.2,19.9,34.5,19.5,34.5,19.1L34.5,19.1z M7.1,6.1l23.9,12.9L7.1,32V6.1L7.1,6.1z" />
                </svg>
            </button>
            <button class="amc-videoplayer-pause" @onclick="PauseVideo">
                <svg viewBox="0 0 36 40">
                    <path class="amc-videoplayer-svg-fill" d="M11.8,36L11.8,36c-1.5,0-2.8-1.3-2.8-2.8V6.9c0-1.5,1.3-2.8,2.8-2.8h0c1.5,0,2.8,1.3,2.8,2.8v26.3 C14.6,34.7,13.3,36,11.8,36z" />
                    <path class="amc-videoplayer-svg-fill" d="M24.6,36L24.6,36c-1.5,0-2.8-1.3-2.8-2.8V6.9c0-1.5,1.3-2.8,2.8-2.8h0c1.5,0,2.8,1.3,2.8,2.8v26.3 C27.4,34.7,26.2,36,24.6,36z" />
                </svg>
            </button>
            <button class="amc-videoplayer-stop" @onclick="StopVideo">Stop</button>
        </div>

        <div class="amc-videoplayer-controls-middle">
            <span class="amc-videoplayer-duration"></span>
        </div>

        <div class="amc-videoplayer-controls-right">
            <button class="amc-videoplayer-enterfullscreen" @onclick="EnterFullScreen">Full Screen</button>
            <button class="amc-videoplayer-exitfullscreen" @onclick="ExitFullScreen">Exit Full Screen</button>
        </div>
    </div>

    <div class="amc-videoplayer-progress" @onmousedown="OnProgressMouseDown">
        <ProgressBar Value="CurrentTime" Total="Duration" Style="ProgressBarStyle" OnChange="OnProgressChange" />
    </div>

</div>

@code {
    private ElementReference ComponentElement { get; set; }

    [Parameter]
    public int HideControlsDelay { get; set; } = 3000;

    private Task<IJSObjectReference> _module;
    private Task<IJSObjectReference> Module => _module ??= GeneralMethods.GetIJSObjectReference(jsRuntime, "videoplayer/videoplayer.js");

    private string ClassAttributes { get; set; } = string.Empty;

    private bool IsUserMovingMouse = false;
    private bool IsUserChangingProgress = false;
    private bool IsVideoPlaying = false;
    private bool IsFullScreen = false;

    private bool IsUserInteracting => IsUserMovingMouse || IsUserChangingProgress;

    private bool HideControls => !IsUserInteracting && CurrentTime > 0;

    private void Repaint()
    {
        ProgressBarStyle = HideControls ? ProgressBarStyle.Flat : ProgressBarStyle.Circle;

        List<string> attributes = new();

        if (HideControls)
            attributes.Add("_hidecontrols");

        if (IsVideoPlaying)
            attributes.Add("_playing");

        if (IsFullScreen)
            attributes.Add("_fullscreen");

        ClassAttributes = string.Join(' ', attributes);
    }

    [Parameter]
    public string Title { get; set; }

    [Parameter]
    public string VideoUrl { get; set; }

    public double Duration { get; set; } = 0;
    public double CurrentTime { get; set; } = 0;

    private ProgressBarStyle ProgressBarStyle = ProgressBarStyle.Circle;

    [Parameter]
    public Action<VideoState> TimeUpdate { get; set; }

    [Parameter]
    public EventCallback<VideoState> TimeUpdateEvent { get; set; }
    bool TimeUpdateRequired => TimeUpdate is object;
    bool TimeUpdateEventRequired => TimeUpdateEvent.HasDelegate;
    bool EventFiredEventRequired => EventFiredEvent.HasDelegate;
    bool EventFiredRequired => EventFired is object;
    [Parameter] public Action<VideoEventData> EventFired { get; set; }
    [Parameter] public EventCallback<VideoEventData> EventFiredEvent { get; set; }

    [Parameter]
    public Dictionary<VideoEvents, VideoStateOptions> VideoEventOptions { get; set; }
    bool RegisterEventFired => EventFiredEventRequired || EventFiredRequired;

    [Parameter]
    public Components.VideoPlayerSettings Settings { get; set; }

    private Guid latestId = Guid.Empty;

    public async Task MainMouseMove(MouseEventArgs args)
    {
        IsUserMovingMouse = true;

        Repaint();

        latestId = Guid.NewGuid();

        await ProgressiveDelay(latestId);
    }

    private async Task ProgressiveDelay(Guid id)
    {
        await Task.Delay(HideControlsDelay);

        if (id != latestId)
            return;

        IsUserMovingMouse = false;
        Repaint();
    }

    public async Task OnProgressMouseDown(MouseEventArgs args)
    {
        IsUserChangingProgress = true;
    }

    public async Task OnProgressChange(ChangeEventArgs args)
    {
        var module = await Module;

        await module.InvokeVoidAsync("changeCurrentTime", ComponentElement, Convert.ToDouble(args.Value));

        IsUserChangingProgress = false;

        if (CurrentTime == Duration)
            await StopVideo();
        else
        {
            await Task.Delay(HideControlsDelay);
            Repaint();
        }
    }

    public async Task OnVideoChange(ChangeEventArgs args)
    {
        VideoEventData eventData = JsonSerializer.Deserialize<VideoEventData>((string)args.Value);

        IsVideoPlaying = !eventData.State.Paused;
        Repaint();

        switch (eventData.EventName)
        {
            case VideoEvents.TimeUpdate:

                if (!IsUserChangingProgress)
                {
                    CurrentTime = eventData.State.CurrentTime;

                    if (CurrentTime == Duration)
                        await StopVideo();
                }
                break;

            default: break;
        }
    }

    public async Task OnEmptyClick(MouseEventArgs args)
    {
        if (IsVideoPlaying)
            await PauseVideo();
        else await PlayVideo();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            var module = await Module;

            await module.InvokeVoidAsync("init", ComponentElement);
            
            await Implement(VideoEvents.TimeUpdate);
            await Implement(VideoEvents.Play);
            await Implement(VideoEvents.Pause);
        }
    }

    async Task Implement(VideoEvents eventName)
    {

        VideoStateOptions options = new VideoStateOptions() { All = true };
        VideoEventOptions?.TryGetValue(eventName, out options);

        var module = await Module;

        await module.InvokeVoidAsync("registerCustomEventHandler", ComponentElement, eventName.ToString().ToLower(), options.GetPayload());
    }

    public async Task VideoLoaded()
    {
        var module = await Module;

        VideoInfo videoInfo = await module.InvokeAsync<VideoInfo>("getVideoInfo", ComponentElement);

        Duration = Convert.ToDouble(videoInfo.Duration);
    }

    public async Task PlayVideo()
    {
        var module = await Module;

        await module.InvokeVoidAsync("play", ComponentElement);
    }

    public async Task PauseVideo()
    {
        var module = await Module;

        await module.InvokeVoidAsync("pause", ComponentElement);
    }

    public async Task EnterFullScreen()
    {
        var module = await Module;

        await module.InvokeVoidAsync("enterFullScreen", ComponentElement);
    }

    public async Task ExitFullScreen()
    {
        var module = await Module;

        await module.InvokeVoidAsync("exitFullScreen", ComponentElement);
    }

    public async Task OnFullScreenChange(EventArgs args)
    {
        IsFullScreen = !IsFullScreen;

        Repaint();
    }

    public async Task StopVideo()
    {
        CurrentTime = 0;

        var module = await Module;

        await module.InvokeVoidAsync("stop", ComponentElement);

        Repaint();
    }

    public async ValueTask DisposeAsync()
    {
        if (_module != null)
        {
            var module = await _module;
            await module.DisposeAsync();
        }
    }

    protected override async void OnParametersSet()
    {
        base.OnParametersSet();
    }
}